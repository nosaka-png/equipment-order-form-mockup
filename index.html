<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALLDATA_備品発注フォーム（Dir側）</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .option-checks { display:flex; gap:20px; flex-wrap:wrap; padding:4px 0; }
    .option-checks label { display:flex; align-items:center; gap:6px; cursor:pointer; font-size:0.9rem; }
    .option-checks input[type="checkbox"] { width:16px; height:16px; }
    .calc-inputs { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; margin-bottom:16px; }
    .calc-inputs .form-group { min-width:160px; }
    .auto-badge { display:inline-block; padding:1px 8px; border-radius:3px; font-size:0.72rem; font-weight:600; background:#e3f2fd; color:#1565c0; margin-left:6px; vertical-align:middle; }
    .option-badge { display:inline-block; padding:1px 8px; border-radius:3px; font-size:0.72rem; font-weight:600; background:#fff3e0; color:#e65100; margin-left:6px; vertical-align:middle; }
    .manual-badge { display:inline-block; padding:1px 8px; border-radius:3px; font-size:0.72rem; font-weight:600; background:#f3e5f5; color:#7b1fa2; margin-left:6px; vertical-align:middle; }
    #equipmentSection { display:none; }
    #equipmentSection.is-visible { display:block; }

    /* 備品追加ボタン */
    .btn--add-item {
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 18px;
      background:#f3e5f5; color:#7b1fa2;
      border:1px solid #ce93d8; border-radius:4px;
      font-size:0.85rem; font-weight:600;
      cursor:pointer; transition:background 0.15s;
    }
    .btn--add-item:hover { background:#e1bee7; }

    /* 備品選択モーダル */
    .item-picker-overlay {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.45); z-index:3000;
      justify-content:center; align-items:center;
    }
    .item-picker-overlay.is-visible { display:flex; }
    .item-picker {
      background:#fff; border-radius:8px;
      width:720px; max-width:92vw; max-height:85vh;
      display:flex; flex-direction:column;
      box-shadow:0 8px 32px rgba(0,0,0,0.2);
    }
    .item-picker__header {
      padding:18px 24px;
      border-bottom:1px solid #e0e0e0;
      display:flex; justify-content:space-between; align-items:center;
    }
    .item-picker__header h3 { margin:0; font-size:1.05rem; }
    .item-picker__close {
      background:none; border:none; font-size:1.6rem;
      cursor:pointer; color:#999; line-height:1;
    }
    .item-picker__close:hover { color:#333; }
    .item-picker__search {
      padding:12px 24px;
      border-bottom:1px solid #e0e0e0;
    }
    .item-picker__search input {
      width:100%; padding:8px 12px;
      border:1px solid #ccc; border-radius:4px;
      font-size:0.9rem; font-family:inherit;
    }
    .item-picker__search input:focus { outline:none; border-color:#7b1fa2; box-shadow:0 0 0 2px rgba(123,31,162,0.15); }
    .item-picker__body {
      flex:1; overflow-y:auto; padding:0;
    }
    .item-picker__category {
      padding:10px 24px 4px;
      font-size:0.8rem; font-weight:700;
      color:#999; text-transform:uppercase;
      background:#fafafa;
      border-top:1px solid #f0f0f0;
      position:sticky; top:0; z-index:1;
    }
    .item-picker__row {
      display:flex; align-items:center; gap:12px;
      padding:10px 24px;
      border-bottom:1px solid #f5f5f5;
      cursor:pointer; transition:background 0.1s;
    }
    .item-picker__row:hover { background:#fce4ec20; }
    .item-picker__row.is-checked { background:#f3e5f5; }
    .item-picker__row.is-already { opacity:0.45; cursor:default; }
    .item-picker__row input[type="checkbox"] { width:16px; height:16px; flex-shrink:0; }
    .item-picker__row .ip-name { font-size:0.9rem; font-weight:500; flex:1; }
    .item-picker__row .ip-cat { font-size:0.78rem; color:#999; width:90px; text-align:right; }
    .item-picker__row .ip-stock { font-size:0.78rem; color:#999; width:60px; text-align:right; }
    .item-picker__row .ip-qty {
      width:70px;
    }
    .item-picker__row .ip-qty input {
      width:100%; padding:4px 6px;
      border:1px solid #ccc; border-radius:3px;
      font-size:0.85rem; text-align:right;
      font-family:inherit;
    }
    .item-picker__row .ip-already { font-size:0.75rem; color:#999; font-style:italic; }
    .item-picker__footer {
      padding:14px 24px;
      border-top:1px solid #e0e0e0;
      display:flex; justify-content:space-between; align-items:center;
    }
    .item-picker__footer .ip-count { font-size:0.85rem; color:#777; }
    .item-picker__footer .ip-count strong { color:#7b1fa2; }

    /* メンター オートコンプリート */
    .mentor-search-wrap { position: relative; }
    .mentor-search {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
    }
    .mentor-search:focus { outline:none; border-color:#1976d2; box-shadow:0 0 0 2px rgba(25,118,210,0.15); }
    .mentor-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .mentor-dropdown.is-open { display: block; }
    .mentor-dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.88rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mentor-dropdown-item:hover { background: #e3f2fd; }
    .mentor-dropdown-item .mentor-email { color: #999; font-size: 0.78rem; }
    .mentor-dropdown-empty { padding: 10px 12px; color: #999; font-size: 0.85rem; }

    .selected-mentors { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .mentor-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #90caf9;
      border-radius: 16px;
      padding: 4px 10px 4px 14px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .mentor-tag .tag-remove {
      cursor: pointer;
      background: none;
      border: none;
      color: #1565c0;
      font-size: 1rem;
      line-height: 1;
      padding: 0 2px;
      opacity: 0.6;
    }
    .mentor-tag .tag-remove:hover { opacity: 1; }
  </style>
</head>
<body>

  <!-- ヘッダー -->
  <header class="header">
    <h1 class="header__title">ALLDATA_備品発注フォーム</h1>
    <span class="header__role header__role--dir">Dir側</span>
  </header>

  <div style="padding:0 24px; display:flex; gap:20px; flex-wrap:wrap;">
    <a href="dashboard.html" class="nav-link" style="margin:16px 0 0;">&#8592; ダッシュボード</a>
    <a href="view-form.html" class="nav-link" style="margin:16px 0 0;">&#8594; アズロジ側フォーム</a>
    <a href="dir-response.html" class="nav-link" style="margin:16px 0 0;">&#8594; 欠品対応入力</a>
    <a href="mentor-check.html" class="nav-link" style="margin:16px 0 0;">&#8594; メンターチェック</a>
  </div>

  <main class="main">

    <!-- 発注者情報 -->
    <div class="section">
      <div class="section__header">発注者情報</div>
      <div class="section__body">
        <div class="form-inline">
          <div class="form-group">
            <label class="form-label">発注者名 <span class="required">※必須</span></label>
            <input type="text" class="form-input" placeholder="例：山田 太郎" id="ordererName">
          </div>
          <div class="form-group">
            <label class="form-label">所属部署 <span class="required">※必須</span></label>
            <select class="form-select" id="department">
              <option value="">-- 選択してください --</option>
              <option value="営業部">営業部</option>
              <option value="開発部">開発部</option>
              <option value="総務部">総務部</option>
              <option value="人事部">人事部</option>
              <option value="経理部">経理部</option>
              <option value="マーケティング部">マーケティング部</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- 研修情報 -->
    <div class="section">
      <div class="section__header">研修情報</div>
      <div class="section__body">
        <div class="form-group">
          <label class="form-label">研修ID <span class="required">※必須</span></label>
          <select class="form-select" id="trainingId">
            <option value="">-- 研修を選択してください --</option>
          </select>
        </div>
        <!-- 宛先 -->
        <div style="margin-top:16px; padding:14px 16px; background:#fafafa; border:1px solid #eee; border-radius:4px;">
          <label class="form-label" style="margin-bottom:10px; font-size:0.95rem;">宛先情報 <span class="required">※必須</span></label>
          <div class="form-inline">
            <div class="form-group" style="flex:0 0 140px; min-width:140px;">
              <label class="form-label">郵便番号</label>
              <input type="text" class="form-input" placeholder="例：100-0005" id="destZip" maxlength="8">
            </div>
            <div class="form-group" style="flex:2;">
              <label class="form-label">住所</label>
              <input type="text" class="form-input" placeholder="例：東京都千代田区丸の内1-1-1" id="destAddress">
            </div>
          </div>
          <div class="form-inline" style="margin-top:8px;">
            <div class="form-group">
              <label class="form-label">会社名</label>
              <input type="text" class="form-input" placeholder="例：株式会社トヨタ自動車" id="destCompany">
            </div>
            <div class="form-group">
              <label class="form-label">部署名</label>
              <input type="text" class="form-input" placeholder="例：人材開発部 研修課" id="destDept">
            </div>
          </div>
          <div class="form-inline" style="margin-top:8px;">
            <div class="form-group">
              <label class="form-label">宛名</label>
              <input type="text" class="form-input" placeholder="例：鈴木 太郎 様" id="destName">
            </div>
            <div class="form-group" style="flex:0 0 200px; min-width:200px;">
              <label class="form-label">電話番号</label>
              <input type="tel" class="form-input" placeholder="例：03-1234-5678" id="destPhone">
            </div>
          </div>
        </div>

        <!-- 到着希望 -->
        <div class="form-inline" style="margin-top:16px;">
          <div class="form-group">
            <label class="form-label">到着希望日 <span class="required">※必須</span></label>
            <input type="date" class="form-input" id="arrivalDate">
          </div>
          <div class="form-group">
            <label class="form-label">希望時間帯 <span class="required">※必須</span></label>
            <select class="form-select" id="arrivalTimeSlot">
              <option value="">-- 時間帯を選択 --</option>
              <option value="午前中">午前中（～12:00）</option>
              <option value="14:00-16:00">14:00～16:00</option>
              <option value="16:00-18:00">16:00～18:00</option>
              <option value="18:00-20:00">18:00～20:00</option>
              <option value="19:00-21:00">19:00～21:00</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- 耐久財一覧（研修種別選択後に表示） -->
    <div class="section" id="equipmentSection">
      <div class="section__header">耐久財一覧 <span id="selectedTrainingLabel" style="font-weight:400; font-size:0.85rem; color:#1976d2;"></span></div>
      <div class="section__body">

        <!-- 人数・チーム数入力 -->
        <div class="calc-inputs">
          <div class="form-group">
            <label class="form-label">研修人数 <span class="required">※必須</span></label>
            <input type="number" class="form-input form-input--short" min="1" value="" placeholder="人数" id="numPeople">
          </div>
          <div class="form-group">
            <label class="form-label">チーム数 <span class="required">※必須</span></label>
            <input type="number" class="form-input form-input--short" min="1" value="" placeholder="チーム数" id="numTeams">
          </div>
          <div class="form-group">
            <button type="button" class="btn btn--primary" id="btnCalc" style="margin-bottom:0;">数量を算出</button>
          </div>
        </div>

        <!-- オプション -->
        <div class="form-group" style="margin-bottom:16px;">
          <label class="form-label">オプション選択</label>
          <div class="option-checks">
            <label><input type="checkbox" value="プロジェクタ" class="option-check"> プロジェクタ</label>
            <label><input type="checkbox" value="音響" class="option-check"> 音響</label>
            <label><input type="checkbox" value="3口アース" class="option-check"> 3口アース</label>
            <label><input type="checkbox" value="PCレンタル" class="option-check"> PCレンタル</label>
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <p style="font-size:0.85rem; color:#777; margin:0;">
            研修種別に基づく必要備品が自動表示されます。数量は人数・チーム数から自動算出されます。
          </p>
          <button type="button" class="btn--add-item" id="btnAddItem">＋ 一覧から追加</button>
        </div>
        <div class="table-wrap">
          <table class="data-table" id="itemTable">
            <thead>
              <tr>
                <th>品目名</th>
                <th>カテゴリ</th>
                <th>研修種別</th>
                <th>区分</th>
                <th style="text-align:right;">現在庫数</th>
                <th>在庫状況</th>
                <th style="width:100px; text-align:right;">必要数量</th>
              </tr>
            </thead>
            <tbody id="itemTableBody">
              <!-- JSで動的生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- メンター指定 -->
    <div class="section">
      <div class="section__header">メンター指定（備品チェック権限）</div>
      <div class="section__body">
        <p style="font-size:0.85rem; color:#777; margin-bottom:12px;">
          現場で備品の受取・返送チェックを行うメンター（アルバイトスタッフ）を指定してください。<br>
          名前を入力すると候補が表示されます。複数名選択できます。
        </p>
        <div class="mentor-search-wrap">
          <input type="text" class="mentor-search" id="mentorSearch" placeholder="メンター名を入力して検索..." autocomplete="off">
          <div class="mentor-dropdown" id="mentorDropdown"></div>
        </div>
        <div class="selected-mentors" id="selectedMentors"></div>
      </div>
    </div>

    <!-- 備考 -->
    <div class="section">
      <div class="section__header">備考・特記事項</div>
      <div class="section__body">
        <div class="form-group">
          <label class="form-label">備考</label>
          <textarea class="form-textarea" placeholder="発注に関する補足事項があれば記入してください" id="remarks"></textarea>
        </div>
      </div>
    </div>

    <!-- 発注ボタン -->
    <div class="btn-group">
      <button type="button" class="btn btn--primary" id="btnOrder">発注決定</button>
    </div>

  </main>

  <!-- 確認モーダル -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <div class="modal__title">発注内容の確認</div>
      <div class="modal__message" id="modalMessage"></div>
      <div class="modal__actions">
        <button class="btn btn--cancel" id="btnModalCancel">キャンセル</button>
        <button class="btn btn--success" id="btnModalConfirm">確定・Slack共有</button>
      </div>
    </div>
  </div>

  <!-- 備品選択ポップアップ -->
  <div class="item-picker-overlay" id="itemPickerOverlay">
    <div class="item-picker">
      <div class="item-picker__header">
        <h3>備品一覧から追加（イレギュラー対応）</h3>
        <button class="item-picker__close" id="itemPickerClose">&times;</button>
      </div>
      <div class="item-picker__search">
        <input type="text" placeholder="品目名・カテゴリで検索..." id="itemPickerSearch" autocomplete="off">
      </div>
      <div class="item-picker__body" id="itemPickerBody">
        <!-- JSで動的生成 -->
      </div>
      <div class="item-picker__footer">
        <span class="ip-count" id="itemPickerCount">選択: <strong>0</strong> 品目</span>
        <div style="display:flex; gap:8px;">
          <button class="btn btn--cancel" id="itemPickerCancel">キャンセル</button>
          <button class="btn btn--primary" id="itemPickerConfirm" style="background:#7b1fa2; border-color:#7b1fa2;">追加する</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 完了アラート -->
  <div class="alert alert--success" id="successAlert" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:2000; min-width:360px;">
    閲覧用シート＆フォームを生成し、Slackでアズロジ側へ共有しました。
  </div>

  <footer class="footer">
    備品発注フォーム モックアップ &copy; 2026
  </footer>

  <script>
  (function () {
    // ==============================
    // 研修DB（ダミー）
    // ==============================
    var trainingDB = [
      { id: '00001', name: '00001_トヨタDX2Days 2/12-13',        type: 'DX' },
      { id: '00002', name: '00002_ソニーDXアドバンス1Day 2/20',   type: 'DX' },
      { id: '00003', name: '00003_日立AI入門2Days 3/5-6',         type: 'AI' },
      { id: '00004', name: '00004_富士通AI実践3Days 3/10-12',     type: 'AI' },
      { id: '00005', name: '00005_パナソニックCD研修1Day 3/15',   type: 'CD' },
      { id: '00006', name: '00006_NEC模造紙WS1Day 3/18',          type: '模造紙' },
      { id: '00007', name: '00007_キヤノン模造紙WS2Days 3/22-23', type: '模造紙' },
      { id: '00008', name: '00008_KDDI_AIA実践2Days 3/25-26',     type: 'AIA' },
      { id: '00009', name: '00009_楽天BI分析1Day 4/2',            type: 'BI' },
      { id: '00010', name: '00010_三菱UFJBI応用2Days 4/8-9',      type: 'BI' }
    ];

    // ==============================
    // 研修種別ごとの必要備品
    //   perPerson: 人数あたり, perTeam: チーム数あたり, fixed: 固定数
    // ==============================
    var equipmentByType = {
      'DX': [
        { name: 'ノートPC',               category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:25 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'モニター（24インチ）',    category: 'PC周辺機器', perPerson:0, perTeam:1, fixed:0, stock:8  },
        { name: 'ホワイトボードマーカーセット', category: '文具', perPerson:0, perTeam:1, fixed:0, stock:20 },
        { name: '付箋（大）',              category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:50 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      'AI': [
        { name: 'ノートPC（GPU搭載）',    category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:10 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'LANケーブル（3m）',       category: 'ケーブル',   perPerson:1, perTeam:0, fixed:0, stock:20 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'ホワイトボードマーカーセット', category: '文具', perPerson:0, perTeam:1, fixed:0, stock:20 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      'CD': [
        { name: 'ノートPC',               category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:25 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'USBメモリ（32GB）',       category: 'メディア',   perPerson:1, perTeam:0, fixed:0, stock:40 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      '模造紙': [
        { name: '模造紙（白）',            category: '紙類',       perPerson:0, perTeam:3, fixed:0, stock:100 },
        { name: 'マーカー（太字8色セット）', category: '文具',     perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: '付箋（大）',              category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:50 },
        { name: '付箋（小）',              category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:50 },
        { name: 'マスキングテープ',        category: '文具',       perPerson:0, perTeam:1, fixed:0, stock:20 },
        { name: 'ドットシール',            category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:60 }
      ],
      'AIA': [
        { name: 'ノートPC（GPU搭載）',    category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:10 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'USBハブ（4ポート）',      category: 'PC周辺機器', perPerson:0, perTeam:1, fixed:0, stock:8  },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'LANケーブル（3m）',       category: 'ケーブル',   perPerson:1, perTeam:0, fixed:0, stock:20 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      'BI': [
        { name: 'ノートPC',               category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:25 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'モニター（24インチ）',    category: 'PC周辺機器', perPerson:0, perTeam:1, fixed:0, stock:8  },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ]
    };

    // ==============================
    // オプション備品
    // ==============================
    var optionEquipment = {
      'プロジェクタ': [
        { name: 'プロジェクター',          category: '映像機器', fixed:1, stock:3 },
        { name: 'プロジェクタースクリーン', category: '映像機器', fixed:1, stock:3 },
        { name: 'HDMIケーブル（5m）',      category: 'ケーブル', fixed:1, stock:5 }
      ],
      '音響': [
        { name: 'ワイヤレススピーカー',    category: '音響機器', fixed:1, stock:4 },
        { name: 'ワイヤレスマイク',        category: '音響機器', fixed:2, stock:6 }
      ],
      '3口アース': [
        { name: '3口アース付き延長コード（5m）', category: '電源', fixed:2, stock:8 }
      ],
      'PCレンタル': [
        { name: 'レンタルPC（Windows）',   category: 'PC機器', perPerson:1, stock:20 }
      ]
    };

    // ==============================
    // 全備品マスターDB（全種別・全オプション + 汎用備品）
    // ==============================
    var allEquipmentMaster = [
      // PC機器
      { name: 'ノートPC',                    category: 'PC機器',     stock: 25 },
      { name: 'ノートPC（GPU搭載）',         category: 'PC機器',     stock: 10 },
      { name: 'レンタルPC（Windows）',        category: 'PC機器',     stock: 20 },
      { name: 'デスクトップPC',               category: 'PC機器',     stock: 5 },
      { name: 'タブレット（iPad）',           category: 'PC機器',     stock: 12 },
      // PC周辺機器
      { name: 'マウス',                       category: 'PC周辺機器', stock: 30 },
      { name: 'ワイヤレスキーボード',         category: 'PC周辺機器', stock: 15 },
      { name: 'モニター（24インチ）',         category: 'PC周辺機器', stock: 8 },
      { name: 'モニター（27インチ）',         category: 'PC周辺機器', stock: 4 },
      { name: 'USBハブ（4ポート）',           category: 'PC周辺機器', stock: 8 },
      { name: 'Webカメラ',                    category: 'PC周辺機器', stock: 10 },
      { name: 'ヘッドセット',                 category: 'PC周辺機器', stock: 15 },
      // ケーブル
      { name: 'HDMIケーブル',                 category: 'ケーブル',   stock: 15 },
      { name: 'HDMIケーブル（5m）',           category: 'ケーブル',   stock: 5 },
      { name: 'LANケーブル（3m）',            category: 'ケーブル',   stock: 20 },
      { name: 'LANケーブル（10m）',           category: 'ケーブル',   stock: 8 },
      { name: 'USB-Cケーブル',                category: 'ケーブル',   stock: 18 },
      { name: 'VGAケーブル',                  category: 'ケーブル',   stock: 6 },
      // 電源
      { name: '電源タップ（6口）',            category: '電源',       stock: 12 },
      { name: '3口アース付き延長コード（5m）',category: '電源',       stock: 8 },
      { name: '電源タップ（10口）',           category: '電源',       stock: 5 },
      { name: 'ポータブル電源',               category: '電源',       stock: 3 },
      // 映像機器
      { name: 'プロジェクター',               category: '映像機器',   stock: 3 },
      { name: 'プロジェクタースクリーン',     category: '映像機器',   stock: 3 },
      { name: '大型モニター（55インチ）',     category: '映像機器',   stock: 2 },
      { name: 'モニタースタンド',             category: '映像機器',   stock: 4 },
      // 音響機器
      { name: 'ワイヤレススピーカー',         category: '音響機器',   stock: 4 },
      { name: 'ワイヤレスマイク',             category: '音響機器',   stock: 6 },
      { name: 'ピンマイク',                   category: '音響機器',   stock: 4 },
      { name: 'ミキサー',                     category: '音響機器',   stock: 2 },
      // 文具
      { name: 'ホワイトボードマーカーセット', category: '文具',       stock: 20 },
      { name: 'マーカー（太字8色セット）',    category: '文具',       stock: 15 },
      { name: '付箋（大）',                   category: '文具',       stock: 50 },
      { name: '付箋（小）',                   category: '文具',       stock: 50 },
      { name: 'マスキングテープ',             category: '文具',       stock: 20 },
      { name: 'ドットシール',                 category: '文具',       stock: 60 },
      { name: 'ボールペン（黒）',             category: '文具',       stock: 100 },
      { name: '名札ホルダー',                 category: '文具',       stock: 50 },
      { name: 'クリアファイル（A4）',         category: '文具',       stock: 80 },
      { name: 'バインダー',                   category: '文具',       stock: 30 },
      // 紙類
      { name: '模造紙（白）',                 category: '紙類',       stock: 100 },
      { name: '模造紙（方眼）',               category: '紙類',       stock: 40 },
      { name: 'コピー用紙（A4 500枚）',       category: '紙類',       stock: 20 },
      { name: 'フリップチャート用紙',         category: '紙類',       stock: 15 },
      // メディア
      { name: 'USBメモリ（32GB）',            category: 'メディア',   stock: 40 },
      { name: 'USBメモリ（64GB）',            category: 'メディア',   stock: 20 },
      { name: 'SDカード（32GB）',             category: 'メディア',   stock: 10 },
      // 什器
      { name: 'ホワイトボード（自立型）',     category: '什器',       stock: 6 },
      { name: 'フリップチャートスタンド',     category: '什器',       stock: 4 },
      { name: 'パーテーション',               category: '什器',       stock: 8 },
      { name: '折りたたみ机',                 category: '什器',       stock: 10 },
      { name: '折りたたみ椅子',               category: '什器',       stock: 30 },
      // その他
      { name: 'Wi-Fiルーター（モバイル）',    category: 'ネットワーク', stock: 5 },
      { name: 'LANスイッチングハブ（8ポート）',category: 'ネットワーク', stock: 4 },
      { name: 'タイマー（デジタル大型）',     category: 'その他',     stock: 6 },
      { name: 'レーザーポインター',           category: 'その他',     stock: 8 },
      { name: 'ネームプレート',               category: 'その他',     stock: 40 },
      { name: 'アルコール消毒スプレー',       category: 'その他',     stock: 20 },
      { name: '養生テープ',                   category: 'その他',     stock: 15 },
      { name: 'ガムテープ',                   category: 'その他',     stock: 15 }
    ];

    // 手動追加された品目リスト
    var manualItems = [];

    // ==============================
    // DOM要素
    // ==============================
    var trainingSelect = document.getElementById('trainingId');
    var equipmentSection = document.getElementById('equipmentSection');
    var selectedTrainingLabel = document.getElementById('selectedTrainingLabel');
    var numPeople = document.getElementById('numPeople');
    var numTeams = document.getElementById('numTeams');
    var btnCalc = document.getElementById('btnCalc');
    var itemTableBody = document.getElementById('itemTableBody');
    var btnOrder = document.getElementById('btnOrder');
    var confirmModal = document.getElementById('confirmModal');
    var modalMessage = document.getElementById('modalMessage');
    var btnModalCancel = document.getElementById('btnModalCancel');
    var btnModalConfirm = document.getElementById('btnModalConfirm');
    var successAlert = document.getElementById('successAlert');

    // 現在選択中のトレーニング
    var currentTraining = null;

    // ==============================
    // 研修DBをプルダウンに投入
    // ==============================
    trainingDB.forEach(function (t) {
      var opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.name + '  [' + t.type + ']';
      opt.dataset.type = t.type;
      trainingSelect.appendChild(opt);
    });

    // ==============================
    // 研修選択時 → 耐久財セクション表示
    // ==============================
    trainingSelect.addEventListener('change', function () {
      var selectedOpt = trainingSelect.options[trainingSelect.selectedIndex];
      if (!selectedOpt.value) {
        equipmentSection.classList.remove('is-visible');
        currentTraining = null;
        return;
      }
      currentTraining = trainingDB.find(function (t) { return t.id === selectedOpt.value; });
      selectedTrainingLabel.textContent = '— ' + currentTraining.name + '（種別: ' + currentTraining.type + '）';
      equipmentSection.classList.add('is-visible');
      numPeople.value = '';
      numTeams.value = '';
      renderTable();
    });

    // ==============================
    // オプション変更時 → テーブル再描画
    // ==============================
    document.querySelectorAll('.option-check').forEach(function (cb) {
      cb.addEventListener('change', function () {
        renderTable();
      });
    });

    // ==============================
    // 数量算出ボタン
    // ==============================
    btnCalc.addEventListener('click', function () {
      var people = parseInt(numPeople.value) || 0;
      var teams = parseInt(numTeams.value) || 0;
      if (people < 1 || teams < 1) {
        alert('研修人数とチーム数を1以上で入力してください。');
        return;
      }
      renderTable();
    });

    // ==============================
    // テーブル描画
    // ==============================
    function renderTable() {
      if (!currentTraining) return;
      var people = parseInt(numPeople.value) || 0;
      var teams = parseInt(numTeams.value) || 0;
      var type = currentTraining.type;
      var items = equipmentByType[type] || [];

      // 選択中オプション
      var selectedOptions = [];
      document.querySelectorAll('.option-check:checked').forEach(function (cb) {
        selectedOptions.push(cb.value);
      });

      var html = '';

      // 研修種別の基本備品
      items.forEach(function (item) {
        var qty = 0;
        if (people > 0 && teams > 0) {
          qty = (item.perPerson || 0) * people + (item.perTeam || 0) * teams + (item.fixed || 0);
        }
        var stockClass = item.stock <= 0 ? 'stock-out' : (item.stock < qty ? 'stock-low' : 'stock-ok');
        var stockLabel = item.stock <= 0 ? '欠品' : (item.stock < qty ? '残少' : '十分');
        html += '<tr>';
        html += '<td>' + item.name + '</td>';
        html += '<td>' + item.category + '</td>';
        html += '<td>' + type + '</td>';
        html += '<td>基本<span class="auto-badge">自動</span></td>';
        html += '<td style="text-align:right;">' + item.stock + '</td>';
        html += '<td><span class="' + stockClass + '">' + stockLabel + '</span></td>';
        html += '<td style="text-align:right; font-weight:600;">' + (qty > 0 ? qty : '-') + '</td>';
        html += '</tr>';
      });

      // オプション備品
      selectedOptions.forEach(function (optName) {
        var optItems = optionEquipment[optName] || [];
        optItems.forEach(function (item) {
          var qty = 0;
          if (people > 0 && teams > 0) {
            if (item.perPerson) {
              qty = item.perPerson * people;
            } else {
              qty = item.fixed || 0;
            }
          }
          var stockClass = item.stock <= 0 ? 'stock-out' : (item.stock < qty ? 'stock-low' : 'stock-ok');
          var stockLabel = item.stock <= 0 ? '欠品' : (item.stock < qty ? '残少' : '十分');
          html += '<tr style="background:#fffde7;">';
          html += '<td>' + item.name + '</td>';
          html += '<td>' + item.category + '</td>';
          html += '<td>' + type + '</td>';
          html += '<td><span class="option-badge">' + optName + '</span></td>';
          html += '<td style="text-align:right;">' + item.stock + '</td>';
          html += '<td><span class="' + stockClass + '">' + stockLabel + '</span></td>';
          html += '<td style="text-align:right; font-weight:600;">' + (qty > 0 ? qty : '-') + '</td>';
          html += '</tr>';
        });
      });

      // 手動追加の備品
      manualItems.forEach(function (item, idx) {
        html += '<tr style="background:#f3e5f5;">';
        html += '<td>' + item.name + '</td>';
        html += '<td>' + item.category + '</td>';
        html += '<td>' + type + '</td>';
        html += '<td>手動<span class="manual-badge">追加</span></td>';
        html += '<td style="text-align:right;">' + item.stock + '</td>';
        var stockClass = item.stock <= 0 ? 'stock-out' : (item.stock < item.qty ? 'stock-low' : 'stock-ok');
        var stockLabel = item.stock <= 0 ? '欠品' : (item.stock < item.qty ? '残少' : '十分');
        html += '<td><span class="' + stockClass + '">' + stockLabel + '</span></td>';
        html += '<td style="text-align:right; font-weight:600; white-space:nowrap;">' +
          '<input type="number" class="manual-qty-input" data-manual-idx="' + idx + '" value="' + item.qty + '" min="1" ' +
          'style="width:60px; padding:3px 6px; border:1px solid #ce93d8; border-radius:3px; text-align:right; font-size:0.85rem; font-family:inherit; margin-right:6px;">' +
          '<button type="button" class="manual-remove-btn" data-manual-idx="' + idx + '" ' +
          'style="background:none; border:none; color:#c62828; font-size:1.1rem; cursor:pointer; vertical-align:middle;" title="削除">&times;</button>' +
          '</td>';
        html += '</tr>';
      });

      if (html === '') {
        html = '<tr><td colspan="7" style="text-align:center; color:#999; padding:24px;">研修を選択してください</td></tr>';
      }

      itemTableBody.innerHTML = html;

      // 手動追加品目の数量変更イベント
      itemTableBody.querySelectorAll('.manual-qty-input').forEach(function (input) {
        input.addEventListener('change', function () {
          var idx = parseInt(this.dataset.manualIdx);
          var val = parseInt(this.value) || 1;
          if (val < 1) val = 1;
          manualItems[idx].qty = val;
          this.value = val;
        });
      });

      // 手動追加品目の削除イベント
      itemTableBody.querySelectorAll('.manual-remove-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var idx = parseInt(this.dataset.manualIdx);
          manualItems.splice(idx, 1);
          renderTable();
        });
      });
    }

    // ==============================
    // 備品選択ポップアップ
    // ==============================
    var btnAddItem = document.getElementById('btnAddItem');
    var itemPickerOverlay = document.getElementById('itemPickerOverlay');
    var itemPickerClose = document.getElementById('itemPickerClose');
    var itemPickerSearch = document.getElementById('itemPickerSearch');
    var itemPickerBody = document.getElementById('itemPickerBody');
    var itemPickerCount = document.getElementById('itemPickerCount');
    var itemPickerCancel = document.getElementById('itemPickerCancel');
    var itemPickerConfirm = document.getElementById('itemPickerConfirm');

    var pickerSelections = {}; // { name: qty }

    function getAlreadyInTable() {
      // テーブルに既にある品目名を収集
      var existing = {};
      if (currentTraining) {
        var type = currentTraining.type;
        (equipmentByType[type] || []).forEach(function (item) {
          existing[item.name] = true;
        });
      }
      // オプション備品
      document.querySelectorAll('.option-check:checked').forEach(function (cb) {
        var optItems = optionEquipment[cb.value] || [];
        optItems.forEach(function (item) { existing[item.name] = true; });
      });
      // 手動追加済み
      manualItems.forEach(function (item) { existing[item.name] = true; });
      return existing;
    }

    function renderItemPicker(filter) {
      var existing = getAlreadyInTable();
      var query = (filter || '').trim().toLowerCase();

      // カテゴリ別にグループ化
      var categories = {};
      allEquipmentMaster.forEach(function (item) {
        if (query && item.name.toLowerCase().indexOf(query) === -1 &&
            item.category.toLowerCase().indexOf(query) === -1) return;
        if (!categories[item.category]) categories[item.category] = [];
        categories[item.category].push(item);
      });

      var html = '';
      var catKeys = Object.keys(categories).sort();
      catKeys.forEach(function (cat) {
        html += '<div class="item-picker__category">' + cat + '</div>';
        categories[cat].forEach(function (item) {
          var isAlready = existing[item.name];
          var isChecked = pickerSelections[item.name] !== undefined;
          html += '<div class="item-picker__row' +
            (isChecked ? ' is-checked' : '') +
            (isAlready ? ' is-already' : '') +
            '" data-item-name="' + item.name + '">';
          if (isAlready) {
            html += '<input type="checkbox" disabled checked>';
            html += '<span class="ip-name">' + item.name + '</span>';
            html += '<span class="ip-already">追加済み</span>';
          } else {
            html += '<input type="checkbox"' + (isChecked ? ' checked' : '') + '>';
            html += '<span class="ip-name">' + item.name + '</span>';
            html += '<span class="ip-cat">' + item.category + '</span>';
            html += '<span class="ip-stock">在庫 ' + item.stock + '</span>';
            html += '<span class="ip-qty"><input type="number" min="1" value="' +
              (pickerSelections[item.name] || 1) + '" placeholder="数量"' +
              (isChecked ? '' : ' disabled') + '></span>';
          }
          html += '</div>';
        });
      });

      if (html === '') {
        html = '<div style="padding:30px; text-align:center; color:#999;">該当する備品が見つかりません</div>';
      }

      itemPickerBody.innerHTML = html;
      updatePickerCount();
    }

    function updatePickerCount() {
      var count = Object.keys(pickerSelections).length;
      itemPickerCount.innerHTML = '選択: <strong>' + count + '</strong> 品目';
    }

    // ポップアップを開く
    btnAddItem.addEventListener('click', function () {
      pickerSelections = {};
      itemPickerSearch.value = '';
      renderItemPicker('');
      itemPickerOverlay.classList.add('is-visible');
      setTimeout(function () { itemPickerSearch.focus(); }, 100);
    });

    // 検索
    itemPickerSearch.addEventListener('input', function () {
      renderItemPicker(this.value);
    });

    // 行クリックでチェック切り替え
    itemPickerBody.addEventListener('click', function (e) {
      var row = e.target.closest('.item-picker__row');
      if (!row || row.classList.contains('is-already')) return;

      // 数量入力欄クリック時はトグルしない
      if (e.target.closest('.ip-qty')) return;

      var name = row.dataset.itemName;
      var cb = row.querySelector('input[type="checkbox"]');
      var qtyInput = row.querySelector('.ip-qty input');

      if (pickerSelections[name] !== undefined) {
        // アンチェック
        delete pickerSelections[name];
        cb.checked = false;
        row.classList.remove('is-checked');
        if (qtyInput) qtyInput.disabled = true;
      } else {
        // チェック
        pickerSelections[name] = parseInt(qtyInput.value) || 1;
        cb.checked = true;
        row.classList.add('is-checked');
        if (qtyInput) qtyInput.disabled = false;
      }
      updatePickerCount();
    });

    // 数量変更
    itemPickerBody.addEventListener('change', function (e) {
      if (e.target.closest('.ip-qty')) {
        var row = e.target.closest('.item-picker__row');
        var name = row.dataset.itemName;
        if (pickerSelections[name] !== undefined) {
          pickerSelections[name] = parseInt(e.target.value) || 1;
        }
      }
    });

    // ポップアップ閉じる
    function closeItemPicker() {
      itemPickerOverlay.classList.remove('is-visible');
    }
    itemPickerClose.addEventListener('click', closeItemPicker);
    itemPickerCancel.addEventListener('click', closeItemPicker);
    itemPickerOverlay.addEventListener('click', function (e) {
      if (e.target === itemPickerOverlay) closeItemPicker();
    });

    // 追加確定
    itemPickerConfirm.addEventListener('click', function () {
      var names = Object.keys(pickerSelections);
      if (names.length === 0) {
        closeItemPicker();
        return;
      }

      names.forEach(function (name) {
        var master = allEquipmentMaster.find(function (m) { return m.name === name; });
        if (master) {
          manualItems.push({
            name: master.name,
            category: master.category,
            stock: master.stock,
            qty: pickerSelections[name]
          });
        }
      });

      closeItemPicker();
      renderTable();
    });

    // ==============================
    // メンターDB（ダミー）
    // ==============================
    var mentorDB = [
      { id: 'M001', name: '佐藤 花子',   email: 'sato.hanako@example.com',   area: '東京' },
      { id: 'M002', name: '田中 一郎',   email: 'tanaka.ichiro@example.com',  area: '東京' },
      { id: 'M003', name: '鈴木 美咲',   email: 'suzuki.misaki@example.com',  area: '大阪' },
      { id: 'M004', name: '高橋 健太',   email: 'takahashi.kenta@example.com',area: '名古屋' },
      { id: 'M005', name: '伊藤 さくら', email: 'ito.sakura@example.com',     area: '東京' },
      { id: 'M006', name: '渡辺 翔太',   email: 'watanabe.shota@example.com', area: '福岡' },
      { id: 'M007', name: '山本 あかり', email: 'yamamoto.akari@example.com', area: '大阪' },
      { id: 'M008', name: '中村 大輝',   email: 'nakamura.daiki@example.com', area: '東京' },
      { id: 'M009', name: '小林 真由',   email: 'kobayashi.mayu@example.com', area: '名古屋' },
      { id: 'M010', name: '加藤 陸',     email: 'kato.riku@example.com',      area: '東京' },
      { id: 'M011', name: '吉田 愛',     email: 'yoshida.ai@example.com',     area: '大阪' },
      { id: 'M012', name: '松本 蓮',     email: 'matsumoto.ren@example.com',  area: '福岡' },
      { id: 'M013', name: '井上 七海',   email: 'inoue.nanami@example.com',   area: '東京' },
      { id: 'M014', name: '木村 颯太',   email: 'kimura.sota@example.com',    area: '名古屋' },
      { id: 'M015', name: '林 ひなた',   email: 'hayashi.hinata@example.com', area: '大阪' }
    ];

    // ==============================
    // メンター オートコンプリート
    // ==============================
    var mentorSearch = document.getElementById('mentorSearch');
    var mentorDropdown = document.getElementById('mentorDropdown');
    var selectedMentorsEl = document.getElementById('selectedMentors');
    var selectedMentorIds = [];

    function renderSelectedMentors() {
      selectedMentorsEl.innerHTML = '';
      selectedMentorIds.forEach(function (id) {
        var m = mentorDB.find(function (x) { return x.id === id; });
        if (!m) return;
        var tag = document.createElement('span');
        tag.className = 'mentor-tag';
        tag.innerHTML = m.name + '<span class="tag-email" style="color:#90caf9; font-size:0.78rem; margin-left:2px;">(' + m.area + ')</span>' +
          '<button class="tag-remove" data-id="' + m.id + '">&times;</button>';
        selectedMentorsEl.appendChild(tag);
      });
    }

    // タグ削除
    selectedMentorsEl.addEventListener('click', function (e) {
      var btn = e.target.closest('.tag-remove');
      if (btn) {
        var id = btn.dataset.id;
        selectedMentorIds = selectedMentorIds.filter(function (x) { return x !== id; });
        renderSelectedMentors();
      }
    });

    // 検索入力
    mentorSearch.addEventListener('input', function () {
      var query = this.value.trim().toLowerCase();
      if (query.length === 0) {
        mentorDropdown.classList.remove('is-open');
        return;
      }

      var results = mentorDB.filter(function (m) {
        if (selectedMentorIds.indexOf(m.id) !== -1) return false;
        return m.name.toLowerCase().indexOf(query) !== -1 ||
               m.email.toLowerCase().indexOf(query) !== -1 ||
               m.area.toLowerCase().indexOf(query) !== -1;
      });

      if (results.length === 0) {
        mentorDropdown.innerHTML = '<div class="mentor-dropdown-empty">該当するメンターが見つかりません</div>';
      } else {
        mentorDropdown.innerHTML = results.map(function (m) {
          return '<div class="mentor-dropdown-item" data-id="' + m.id + '">' +
            '<span>' + m.name + ' <span style="color:#999; font-size:0.78rem;">(' + m.area + ')</span></span>' +
            '<span class="mentor-email">' + m.email + '</span>' +
            '</div>';
        }).join('');
      }
      mentorDropdown.classList.add('is-open');
    });

    // ドロップダウン選択
    mentorDropdown.addEventListener('click', function (e) {
      var item = e.target.closest('.mentor-dropdown-item');
      if (item) {
        var id = item.dataset.id;
        if (selectedMentorIds.indexOf(id) === -1) {
          selectedMentorIds.push(id);
          renderSelectedMentors();
        }
        mentorSearch.value = '';
        mentorDropdown.classList.remove('is-open');
        mentorSearch.focus();
      }
    });

    // フォーカスが外れたらドロップダウンを閉じる
    mentorSearch.addEventListener('blur', function () {
      setTimeout(function () { mentorDropdown.classList.remove('is-open'); }, 200);
    });

    // フォーカス時に入力があれば再表示
    mentorSearch.addEventListener('focus', function () {
      if (this.value.trim().length > 0) {
        this.dispatchEvent(new Event('input'));
      }
    });

    // ==============================
    // 発注決定
    // ==============================
    btnOrder.addEventListener('click', function () {
      var ordererName = document.getElementById('ordererName').value.trim();
      var department = document.getElementById('department').value;

      // 宛先情報
      var destZip = document.getElementById('destZip').value.trim();
      var destAddress = document.getElementById('destAddress').value.trim();
      var destCompany = document.getElementById('destCompany').value.trim();
      var destDept = document.getElementById('destDept').value.trim();
      var destName = document.getElementById('destName').value.trim();
      var destPhone = document.getElementById('destPhone').value.trim();

      // 到着希望
      var arrivalDate = document.getElementById('arrivalDate').value;
      var arrivalTimeSlot = document.getElementById('arrivalTimeSlot').value;

      if (!ordererName || !department) {
        alert('発注者名と所属部署は必須項目です。');
        return;
      }
      if (!currentTraining) {
        alert('研修IDを選択してください。');
        return;
      }
      if (!destZip || !destAddress || !destCompany || !destName || !destPhone) {
        alert('宛先情報（郵便番号・住所・会社名・宛名・電話番号）は必須です。');
        return;
      }
      if (!arrivalDate || !arrivalTimeSlot) {
        alert('到着希望日と希望時間帯を選択してください。');
        return;
      }

      var people = parseInt(numPeople.value) || 0;
      var teams = parseInt(numTeams.value) || 0;
      if (people < 1 || teams < 1) {
        alert('研修人数とチーム数を入力し、数量を算出してください。');
        return;
      }

      // 品目収集（自動＋オプション）
      var type = currentTraining.type;
      var selectedItems = [];
      var autoItems = equipmentByType[type] || [];
      autoItems.forEach(function (item) {
        var qty = (item.perPerson || 0) * people + (item.perTeam || 0) * teams + (item.fixed || 0);
        if (qty > 0) selectedItems.push(item.name + ' × ' + qty + '（基本）');
      });
      document.querySelectorAll('.option-check:checked').forEach(function (cb) {
        var optItems = optionEquipment[cb.value] || [];
        optItems.forEach(function (item) {
          var qty = item.perPerson ? item.perPerson * people : (item.fixed || 0);
          if (qty > 0) selectedItems.push(item.name + ' × ' + qty + '（' + cb.value + '）');
        });
      });
      // 手動追加品目
      manualItems.forEach(function (item) {
        selectedItems.push(item.name + ' × ' + item.qty + '（手動追加）');
      });

      if (selectedItems.length === 0) {
        alert('発注する品目がありません。');
        return;
      }

      // 宛先文字列を組み立て
      var destStr = '〒' + destZip + ' ' + destAddress + '<br>' +
        destCompany + (destDept ? ' ' + destDept : '') + '<br>' +
        destName + '　TEL: ' + destPhone;

      // メンター情報を収集
      var mentors = selectedMentorIds.map(function (id) {
        var m = mentorDB.find(function (x) { return x.id === id; });
        return m ? m.name + '（' + m.email + '）' : '';
      }).filter(function (x) { return x; });

      modalMessage.innerHTML =
        '<strong>発注者:</strong> ' + ordererName + '（' + department + '）<br>' +
        '<strong>研修:</strong> ' + currentTraining.name + '<br><br>' +
        '<strong>宛先:</strong><br>' + destStr + '<br><br>' +
        '<strong>到着希望:</strong> ' + arrivalDate + '　' + arrivalTimeSlot + '<br>' +
        '<strong>人数:</strong> ' + people + '名 / <strong>チーム数:</strong> ' + teams + '<br><br>' +
        '<strong>発注品目:</strong><br>' +
        selectedItems.map(function (item) { return '・' + item; }).join('<br>') +
        '<br><br>' +
        (mentors.length > 0
          ? '<strong>チェック権限付与メンター:</strong><br>' + mentors.map(function (m) { return '・' + m; }).join('<br>') + '<br><br>'
          : '') +
        'この内容で閲覧用シート＆フォームを生成し、<br>Slackでアズロジ側へ共有します。よろしいですか？';

      confirmModal.classList.add('is-visible');
    });

    // モーダル：キャンセル
    btnModalCancel.addEventListener('click', function () {
      confirmModal.classList.remove('is-visible');
    });

    // モーダル：確定
    btnModalConfirm.addEventListener('click', function () {
      confirmModal.classList.remove('is-visible');
      successAlert.classList.add('is-visible');
      setTimeout(function () {
        successAlert.classList.remove('is-visible');
      }, 4000);
    });

    // モーダル外クリックで閉じる
    confirmModal.addEventListener('click', function (e) {
      if (e.target === confirmModal) {
        confirmModal.classList.remove('is-visible');
      }
    });

  })();
  </script>

</body>
</html>
