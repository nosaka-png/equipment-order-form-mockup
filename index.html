<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALLDATA_備品発注フォーム（Dir側）</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .option-checks { display:flex; gap:20px; flex-wrap:wrap; padding:4px 0; }
    .option-checks label { display:flex; align-items:center; gap:6px; cursor:pointer; font-size:0.9rem; }
    .option-checks input[type="checkbox"] { width:16px; height:16px; }
    .calc-inputs { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; margin-bottom:16px; }
    .calc-inputs .form-group { min-width:160px; }
    .auto-badge { display:inline-block; padding:1px 8px; border-radius:3px; font-size:0.72rem; font-weight:600; background:#e3f2fd; color:#1565c0; margin-left:6px; vertical-align:middle; }
    .option-badge { display:inline-block; padding:1px 8px; border-radius:3px; font-size:0.72rem; font-weight:600; background:#fff3e0; color:#e65100; margin-left:6px; vertical-align:middle; }
    #equipmentSection { display:none; }
    #equipmentSection.is-visible { display:block; }

    /* メンター オートコンプリート */
    .mentor-search-wrap { position: relative; }
    .mentor-search {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
    }
    .mentor-search:focus { outline:none; border-color:#1976d2; box-shadow:0 0 0 2px rgba(25,118,210,0.15); }
    .mentor-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .mentor-dropdown.is-open { display: block; }
    .mentor-dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.88rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mentor-dropdown-item:hover { background: #e3f2fd; }
    .mentor-dropdown-item .mentor-email { color: #999; font-size: 0.78rem; }
    .mentor-dropdown-empty { padding: 10px 12px; color: #999; font-size: 0.85rem; }

    .selected-mentors { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .mentor-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #90caf9;
      border-radius: 16px;
      padding: 4px 10px 4px 14px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .mentor-tag .tag-remove {
      cursor: pointer;
      background: none;
      border: none;
      color: #1565c0;
      font-size: 1rem;
      line-height: 1;
      padding: 0 2px;
      opacity: 0.6;
    }
    .mentor-tag .tag-remove:hover { opacity: 1; }
  </style>
</head>
<body>

  <!-- ヘッダー -->
  <header class="header">
    <h1 class="header__title">ALLDATA_備品発注フォーム</h1>
    <span class="header__role header__role--dir">Dir側</span>
  </header>

  <div style="padding:0 24px; display:flex; gap:20px; flex-wrap:wrap;">
    <a href="view-form.html" class="nav-link" style="margin:16px 0 0;">&#8594; アズロジ側「閲覧用シート＆フォーム」</a>
    <a href="dir-response.html" class="nav-link" style="margin:16px 0 0;">&#8594; Dir「欠品対応入力」</a>
    <a href="mentor-check.html" class="nav-link" style="margin:16px 0 0;">&#8594; メンター用「備品チェック画面」</a>
  </div>

  <main class="main">

    <!-- 発注者情報 -->
    <div class="section">
      <div class="section__header">発注者情報</div>
      <div class="section__body">
        <div class="form-inline">
          <div class="form-group">
            <label class="form-label">発注者名 <span class="required">※必須</span></label>
            <input type="text" class="form-input" placeholder="例：山田 太郎" id="ordererName">
          </div>
          <div class="form-group">
            <label class="form-label">所属部署 <span class="required">※必須</span></label>
            <select class="form-select" id="department">
              <option value="">-- 選択してください --</option>
              <option value="営業部">営業部</option>
              <option value="開発部">開発部</option>
              <option value="総務部">総務部</option>
              <option value="人事部">人事部</option>
              <option value="経理部">経理部</option>
              <option value="マーケティング部">マーケティング部</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- 研修情報 -->
    <div class="section">
      <div class="section__header">研修情報</div>
      <div class="section__body">
        <div class="form-group">
          <label class="form-label">研修ID <span class="required">※必須</span></label>
          <select class="form-select" id="trainingId">
            <option value="">-- 研修を選択してください --</option>
          </select>
        </div>
        <!-- 宛先 -->
        <div style="margin-top:16px; padding:14px 16px; background:#fafafa; border:1px solid #eee; border-radius:4px;">
          <label class="form-label" style="margin-bottom:10px; font-size:0.95rem;">宛先情報 <span class="required">※必須</span></label>
          <div class="form-inline">
            <div class="form-group" style="flex:0 0 140px; min-width:140px;">
              <label class="form-label">郵便番号</label>
              <input type="text" class="form-input" placeholder="例：100-0005" id="destZip" maxlength="8">
            </div>
            <div class="form-group" style="flex:2;">
              <label class="form-label">住所</label>
              <input type="text" class="form-input" placeholder="例：東京都千代田区丸の内1-1-1" id="destAddress">
            </div>
          </div>
          <div class="form-inline" style="margin-top:8px;">
            <div class="form-group">
              <label class="form-label">会社名</label>
              <input type="text" class="form-input" placeholder="例：株式会社トヨタ自動車" id="destCompany">
            </div>
            <div class="form-group">
              <label class="form-label">部署名</label>
              <input type="text" class="form-input" placeholder="例：人材開発部 研修課" id="destDept">
            </div>
          </div>
          <div class="form-inline" style="margin-top:8px;">
            <div class="form-group">
              <label class="form-label">宛名</label>
              <input type="text" class="form-input" placeholder="例：鈴木 太郎 様" id="destName">
            </div>
            <div class="form-group" style="flex:0 0 200px; min-width:200px;">
              <label class="form-label">電話番号</label>
              <input type="tel" class="form-input" placeholder="例：03-1234-5678" id="destPhone">
            </div>
          </div>
        </div>

        <!-- 到着希望 -->
        <div class="form-inline" style="margin-top:16px;">
          <div class="form-group">
            <label class="form-label">到着希望日 <span class="required">※必須</span></label>
            <input type="date" class="form-input" id="arrivalDate">
          </div>
          <div class="form-group">
            <label class="form-label">希望時間帯 <span class="required">※必須</span></label>
            <select class="form-select" id="arrivalTimeSlot">
              <option value="">-- 時間帯を選択 --</option>
              <option value="午前中">午前中（～12:00）</option>
              <option value="14:00-16:00">14:00～16:00</option>
              <option value="16:00-18:00">16:00～18:00</option>
              <option value="18:00-20:00">18:00～20:00</option>
              <option value="19:00-21:00">19:00～21:00</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- 耐久財一覧（研修種別選択後に表示） -->
    <div class="section" id="equipmentSection">
      <div class="section__header">耐久財一覧 <span id="selectedTrainingLabel" style="font-weight:400; font-size:0.85rem; color:#1976d2;"></span></div>
      <div class="section__body">

        <!-- 人数・チーム数入力 -->
        <div class="calc-inputs">
          <div class="form-group">
            <label class="form-label">研修人数 <span class="required">※必須</span></label>
            <input type="number" class="form-input form-input--short" min="1" value="" placeholder="人数" id="numPeople">
          </div>
          <div class="form-group">
            <label class="form-label">チーム数 <span class="required">※必須</span></label>
            <input type="number" class="form-input form-input--short" min="1" value="" placeholder="チーム数" id="numTeams">
          </div>
          <div class="form-group">
            <button type="button" class="btn btn--primary" id="btnCalc" style="margin-bottom:0;">数量を算出</button>
          </div>
        </div>

        <!-- オプション -->
        <div class="form-group" style="margin-bottom:16px;">
          <label class="form-label">オプション選択</label>
          <div class="option-checks">
            <label><input type="checkbox" value="プロジェクタ" class="option-check"> プロジェクタ</label>
            <label><input type="checkbox" value="音響" class="option-check"> 音響</label>
            <label><input type="checkbox" value="3口アース" class="option-check"> 3口アース</label>
            <label><input type="checkbox" value="PCレンタル" class="option-check"> PCレンタル</label>
          </div>
        </div>

        <p style="font-size:0.85rem; color:#777; margin-bottom:12px;">
          研修種別に基づく必要備品が自動表示されます。数量は人数・チーム数から自動算出されます。
        </p>
        <div class="table-wrap">
          <table class="data-table" id="itemTable">
            <thead>
              <tr>
                <th>品目名</th>
                <th>カテゴリ</th>
                <th>研修種別</th>
                <th>区分</th>
                <th style="text-align:right;">現在庫数</th>
                <th>在庫状況</th>
                <th style="width:100px; text-align:right;">必要数量</th>
              </tr>
            </thead>
            <tbody id="itemTableBody">
              <!-- JSで動的生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- メンター指定 -->
    <div class="section">
      <div class="section__header">メンター指定（備品チェック権限）</div>
      <div class="section__body">
        <p style="font-size:0.85rem; color:#777; margin-bottom:12px;">
          現場で備品の受取・返送チェックを行うメンター（アルバイトスタッフ）を指定してください。<br>
          名前を入力すると候補が表示されます。複数名選択できます。
        </p>
        <div class="mentor-search-wrap">
          <input type="text" class="mentor-search" id="mentorSearch" placeholder="メンター名を入力して検索..." autocomplete="off">
          <div class="mentor-dropdown" id="mentorDropdown"></div>
        </div>
        <div class="selected-mentors" id="selectedMentors"></div>
      </div>
    </div>

    <!-- 備考 -->
    <div class="section">
      <div class="section__header">備考・特記事項</div>
      <div class="section__body">
        <div class="form-group">
          <label class="form-label">備考</label>
          <textarea class="form-textarea" placeholder="発注に関する補足事項があれば記入してください" id="remarks"></textarea>
        </div>
      </div>
    </div>

    <!-- 発注ボタン -->
    <div class="btn-group">
      <button type="button" class="btn btn--primary" id="btnOrder">発注決定</button>
    </div>

  </main>

  <!-- 確認モーダル -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <div class="modal__title">発注内容の確認</div>
      <div class="modal__message" id="modalMessage"></div>
      <div class="modal__actions">
        <button class="btn btn--cancel" id="btnModalCancel">キャンセル</button>
        <button class="btn btn--success" id="btnModalConfirm">確定・Slack共有</button>
      </div>
    </div>
  </div>

  <!-- 完了アラート -->
  <div class="alert alert--success" id="successAlert" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:2000; min-width:360px;">
    閲覧用シート＆フォームを生成し、Slackでアズロジ側へ共有しました。
  </div>

  <footer class="footer">
    備品発注フォーム モックアップ &copy; 2026
  </footer>

  <script>
  (function () {
    // ==============================
    // 研修DB（ダミー）
    // ==============================
    var trainingDB = [
      { id: '00001', name: '00001_トヨタDX2Days 2/12-13',        type: 'DX' },
      { id: '00002', name: '00002_ソニーDXアドバンス1Day 2/20',   type: 'DX' },
      { id: '00003', name: '00003_日立AI入門2Days 3/5-6',         type: 'AI' },
      { id: '00004', name: '00004_富士通AI実践3Days 3/10-12',     type: 'AI' },
      { id: '00005', name: '00005_パナソニックCD研修1Day 3/15',   type: 'CD' },
      { id: '00006', name: '00006_NEC模造紙WS1Day 3/18',          type: '模造紙' },
      { id: '00007', name: '00007_キヤノン模造紙WS2Days 3/22-23', type: '模造紙' },
      { id: '00008', name: '00008_KDDI_AIA実践2Days 3/25-26',     type: 'AIA' },
      { id: '00009', name: '00009_楽天BI分析1Day 4/2',            type: 'BI' },
      { id: '00010', name: '00010_三菱UFJBI応用2Days 4/8-9',      type: 'BI' }
    ];

    // ==============================
    // 研修種別ごとの必要備品
    //   perPerson: 人数あたり, perTeam: チーム数あたり, fixed: 固定数
    // ==============================
    var equipmentByType = {
      'DX': [
        { name: 'ノートPC',               category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:25 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'モニター（24インチ）',    category: 'PC周辺機器', perPerson:0, perTeam:1, fixed:0, stock:8  },
        { name: 'ホワイトボードマーカーセット', category: '文具', perPerson:0, perTeam:1, fixed:0, stock:20 },
        { name: '付箋（大）',              category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:50 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      'AI': [
        { name: 'ノートPC（GPU搭載）',    category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:10 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'LANケーブル（3m）',       category: 'ケーブル',   perPerson:1, perTeam:0, fixed:0, stock:20 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'ホワイトボードマーカーセット', category: '文具', perPerson:0, perTeam:1, fixed:0, stock:20 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      'CD': [
        { name: 'ノートPC',               category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:25 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'USBメモリ（32GB）',       category: 'メディア',   perPerson:1, perTeam:0, fixed:0, stock:40 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      '模造紙': [
        { name: '模造紙（白）',            category: '紙類',       perPerson:0, perTeam:3, fixed:0, stock:100 },
        { name: 'マーカー（太字8色セット）', category: '文具',     perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: '付箋（大）',              category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:50 },
        { name: '付箋（小）',              category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:50 },
        { name: 'マスキングテープ',        category: '文具',       perPerson:0, perTeam:1, fixed:0, stock:20 },
        { name: 'ドットシール',            category: '文具',       perPerson:1, perTeam:0, fixed:0, stock:60 }
      ],
      'AIA': [
        { name: 'ノートPC（GPU搭載）',    category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:10 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'USBハブ（4ポート）',      category: 'PC周辺機器', perPerson:0, perTeam:1, fixed:0, stock:8  },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'LANケーブル（3m）',       category: 'ケーブル',   perPerson:1, perTeam:0, fixed:0, stock:20 },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ],
      'BI': [
        { name: 'ノートPC',               category: 'PC機器',     perPerson:1, perTeam:0, fixed:0, stock:25 },
        { name: 'マウス',                  category: 'PC周辺機器', perPerson:1, perTeam:0, fixed:0, stock:30 },
        { name: 'HDMIケーブル',            category: 'ケーブル',   perPerson:0, perTeam:1, fixed:0, stock:15 },
        { name: 'モニター（24インチ）',    category: 'PC周辺機器', perPerson:0, perTeam:1, fixed:0, stock:8  },
        { name: '電源タップ（6口）',       category: '電源',       perPerson:0, perTeam:1, fixed:0, stock:12 }
      ]
    };

    // ==============================
    // オプション備品
    // ==============================
    var optionEquipment = {
      'プロジェクタ': [
        { name: 'プロジェクター',          category: '映像機器', fixed:1, stock:3 },
        { name: 'プロジェクタースクリーン', category: '映像機器', fixed:1, stock:3 },
        { name: 'HDMIケーブル（5m）',      category: 'ケーブル', fixed:1, stock:5 }
      ],
      '音響': [
        { name: 'ワイヤレススピーカー',    category: '音響機器', fixed:1, stock:4 },
        { name: 'ワイヤレスマイク',        category: '音響機器', fixed:2, stock:6 }
      ],
      '3口アース': [
        { name: '3口アース付き延長コード（5m）', category: '電源', fixed:2, stock:8 }
      ],
      'PCレンタル': [
        { name: 'レンタルPC（Windows）',   category: 'PC機器', perPerson:1, stock:20 }
      ]
    };

    // ==============================
    // DOM要素
    // ==============================
    var trainingSelect = document.getElementById('trainingId');
    var equipmentSection = document.getElementById('equipmentSection');
    var selectedTrainingLabel = document.getElementById('selectedTrainingLabel');
    var numPeople = document.getElementById('numPeople');
    var numTeams = document.getElementById('numTeams');
    var btnCalc = document.getElementById('btnCalc');
    var itemTableBody = document.getElementById('itemTableBody');
    var btnOrder = document.getElementById('btnOrder');
    var confirmModal = document.getElementById('confirmModal');
    var modalMessage = document.getElementById('modalMessage');
    var btnModalCancel = document.getElementById('btnModalCancel');
    var btnModalConfirm = document.getElementById('btnModalConfirm');
    var successAlert = document.getElementById('successAlert');

    // 現在選択中のトレーニング
    var currentTraining = null;

    // ==============================
    // 研修DBをプルダウンに投入
    // ==============================
    trainingDB.forEach(function (t) {
      var opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.name + '  [' + t.type + ']';
      opt.dataset.type = t.type;
      trainingSelect.appendChild(opt);
    });

    // ==============================
    // 研修選択時 → 耐久財セクション表示
    // ==============================
    trainingSelect.addEventListener('change', function () {
      var selectedOpt = trainingSelect.options[trainingSelect.selectedIndex];
      if (!selectedOpt.value) {
        equipmentSection.classList.remove('is-visible');
        currentTraining = null;
        return;
      }
      currentTraining = trainingDB.find(function (t) { return t.id === selectedOpt.value; });
      selectedTrainingLabel.textContent = '— ' + currentTraining.name + '（種別: ' + currentTraining.type + '）';
      equipmentSection.classList.add('is-visible');
      numPeople.value = '';
      numTeams.value = '';
      renderTable();
    });

    // ==============================
    // オプション変更時 → テーブル再描画
    // ==============================
    document.querySelectorAll('.option-check').forEach(function (cb) {
      cb.addEventListener('change', function () {
        renderTable();
      });
    });

    // ==============================
    // 数量算出ボタン
    // ==============================
    btnCalc.addEventListener('click', function () {
      var people = parseInt(numPeople.value) || 0;
      var teams = parseInt(numTeams.value) || 0;
      if (people < 1 || teams < 1) {
        alert('研修人数とチーム数を1以上で入力してください。');
        return;
      }
      renderTable();
    });

    // ==============================
    // テーブル描画
    // ==============================
    function renderTable() {
      if (!currentTraining) return;
      var people = parseInt(numPeople.value) || 0;
      var teams = parseInt(numTeams.value) || 0;
      var type = currentTraining.type;
      var items = equipmentByType[type] || [];

      // 選択中オプション
      var selectedOptions = [];
      document.querySelectorAll('.option-check:checked').forEach(function (cb) {
        selectedOptions.push(cb.value);
      });

      var html = '';

      // 研修種別の基本備品
      items.forEach(function (item) {
        var qty = 0;
        if (people > 0 && teams > 0) {
          qty = (item.perPerson || 0) * people + (item.perTeam || 0) * teams + (item.fixed || 0);
        }
        var stockClass = item.stock <= 0 ? 'stock-out' : (item.stock < qty ? 'stock-low' : 'stock-ok');
        var stockLabel = item.stock <= 0 ? '欠品' : (item.stock < qty ? '残少' : '十分');
        html += '<tr>';
        html += '<td>' + item.name + '</td>';
        html += '<td>' + item.category + '</td>';
        html += '<td>' + type + '</td>';
        html += '<td>基本<span class="auto-badge">自動</span></td>';
        html += '<td style="text-align:right;">' + item.stock + '</td>';
        html += '<td><span class="' + stockClass + '">' + stockLabel + '</span></td>';
        html += '<td style="text-align:right; font-weight:600;">' + (qty > 0 ? qty : '-') + '</td>';
        html += '</tr>';
      });

      // オプション備品
      selectedOptions.forEach(function (optName) {
        var optItems = optionEquipment[optName] || [];
        optItems.forEach(function (item) {
          var qty = 0;
          if (people > 0 && teams > 0) {
            if (item.perPerson) {
              qty = item.perPerson * people;
            } else {
              qty = item.fixed || 0;
            }
          }
          var stockClass = item.stock <= 0 ? 'stock-out' : (item.stock < qty ? 'stock-low' : 'stock-ok');
          var stockLabel = item.stock <= 0 ? '欠品' : (item.stock < qty ? '残少' : '十分');
          html += '<tr style="background:#fffde7;">';
          html += '<td>' + item.name + '</td>';
          html += '<td>' + item.category + '</td>';
          html += '<td>' + type + '</td>';
          html += '<td><span class="option-badge">' + optName + '</span></td>';
          html += '<td style="text-align:right;">' + item.stock + '</td>';
          html += '<td><span class="' + stockClass + '">' + stockLabel + '</span></td>';
          html += '<td style="text-align:right; font-weight:600;">' + (qty > 0 ? qty : '-') + '</td>';
          html += '</tr>';
        });
      });

      if (html === '') {
        html = '<tr><td colspan="7" style="text-align:center; color:#999; padding:24px;">研修を選択してください</td></tr>';
      }

      itemTableBody.innerHTML = html;
    }

    // ==============================
    // メンターDB（ダミー）
    // ==============================
    var mentorDB = [
      { id: 'M001', name: '佐藤 花子',   email: 'sato.hanako@example.com',   area: '東京' },
      { id: 'M002', name: '田中 一郎',   email: 'tanaka.ichiro@example.com',  area: '東京' },
      { id: 'M003', name: '鈴木 美咲',   email: 'suzuki.misaki@example.com',  area: '大阪' },
      { id: 'M004', name: '高橋 健太',   email: 'takahashi.kenta@example.com',area: '名古屋' },
      { id: 'M005', name: '伊藤 さくら', email: 'ito.sakura@example.com',     area: '東京' },
      { id: 'M006', name: '渡辺 翔太',   email: 'watanabe.shota@example.com', area: '福岡' },
      { id: 'M007', name: '山本 あかり', email: 'yamamoto.akari@example.com', area: '大阪' },
      { id: 'M008', name: '中村 大輝',   email: 'nakamura.daiki@example.com', area: '東京' },
      { id: 'M009', name: '小林 真由',   email: 'kobayashi.mayu@example.com', area: '名古屋' },
      { id: 'M010', name: '加藤 陸',     email: 'kato.riku@example.com',      area: '東京' },
      { id: 'M011', name: '吉田 愛',     email: 'yoshida.ai@example.com',     area: '大阪' },
      { id: 'M012', name: '松本 蓮',     email: 'matsumoto.ren@example.com',  area: '福岡' },
      { id: 'M013', name: '井上 七海',   email: 'inoue.nanami@example.com',   area: '東京' },
      { id: 'M014', name: '木村 颯太',   email: 'kimura.sota@example.com',    area: '名古屋' },
      { id: 'M015', name: '林 ひなた',   email: 'hayashi.hinata@example.com', area: '大阪' }
    ];

    // ==============================
    // メンター オートコンプリート
    // ==============================
    var mentorSearch = document.getElementById('mentorSearch');
    var mentorDropdown = document.getElementById('mentorDropdown');
    var selectedMentorsEl = document.getElementById('selectedMentors');
    var selectedMentorIds = [];

    function renderSelectedMentors() {
      selectedMentorsEl.innerHTML = '';
      selectedMentorIds.forEach(function (id) {
        var m = mentorDB.find(function (x) { return x.id === id; });
        if (!m) return;
        var tag = document.createElement('span');
        tag.className = 'mentor-tag';
        tag.innerHTML = m.name + '<span class="tag-email" style="color:#90caf9; font-size:0.78rem; margin-left:2px;">(' + m.area + ')</span>' +
          '<button class="tag-remove" data-id="' + m.id + '">&times;</button>';
        selectedMentorsEl.appendChild(tag);
      });
    }

    // タグ削除
    selectedMentorsEl.addEventListener('click', function (e) {
      var btn = e.target.closest('.tag-remove');
      if (btn) {
        var id = btn.dataset.id;
        selectedMentorIds = selectedMentorIds.filter(function (x) { return x !== id; });
        renderSelectedMentors();
      }
    });

    // 検索入力
    mentorSearch.addEventListener('input', function () {
      var query = this.value.trim().toLowerCase();
      if (query.length === 0) {
        mentorDropdown.classList.remove('is-open');
        return;
      }

      var results = mentorDB.filter(function (m) {
        if (selectedMentorIds.indexOf(m.id) !== -1) return false;
        return m.name.toLowerCase().indexOf(query) !== -1 ||
               m.email.toLowerCase().indexOf(query) !== -1 ||
               m.area.toLowerCase().indexOf(query) !== -1;
      });

      if (results.length === 0) {
        mentorDropdown.innerHTML = '<div class="mentor-dropdown-empty">該当するメンターが見つかりません</div>';
      } else {
        mentorDropdown.innerHTML = results.map(function (m) {
          return '<div class="mentor-dropdown-item" data-id="' + m.id + '">' +
            '<span>' + m.name + ' <span style="color:#999; font-size:0.78rem;">(' + m.area + ')</span></span>' +
            '<span class="mentor-email">' + m.email + '</span>' +
            '</div>';
        }).join('');
      }
      mentorDropdown.classList.add('is-open');
    });

    // ドロップダウン選択
    mentorDropdown.addEventListener('click', function (e) {
      var item = e.target.closest('.mentor-dropdown-item');
      if (item) {
        var id = item.dataset.id;
        if (selectedMentorIds.indexOf(id) === -1) {
          selectedMentorIds.push(id);
          renderSelectedMentors();
        }
        mentorSearch.value = '';
        mentorDropdown.classList.remove('is-open');
        mentorSearch.focus();
      }
    });

    // フォーカスが外れたらドロップダウンを閉じる
    mentorSearch.addEventListener('blur', function () {
      setTimeout(function () { mentorDropdown.classList.remove('is-open'); }, 200);
    });

    // フォーカス時に入力があれば再表示
    mentorSearch.addEventListener('focus', function () {
      if (this.value.trim().length > 0) {
        this.dispatchEvent(new Event('input'));
      }
    });

    // ==============================
    // 発注決定
    // ==============================
    btnOrder.addEventListener('click', function () {
      var ordererName = document.getElementById('ordererName').value.trim();
      var department = document.getElementById('department').value;

      // 宛先情報
      var destZip = document.getElementById('destZip').value.trim();
      var destAddress = document.getElementById('destAddress').value.trim();
      var destCompany = document.getElementById('destCompany').value.trim();
      var destDept = document.getElementById('destDept').value.trim();
      var destName = document.getElementById('destName').value.trim();
      var destPhone = document.getElementById('destPhone').value.trim();

      // 到着希望
      var arrivalDate = document.getElementById('arrivalDate').value;
      var arrivalTimeSlot = document.getElementById('arrivalTimeSlot').value;

      if (!ordererName || !department) {
        alert('発注者名と所属部署は必須項目です。');
        return;
      }
      if (!currentTraining) {
        alert('研修IDを選択してください。');
        return;
      }
      if (!destZip || !destAddress || !destCompany || !destName || !destPhone) {
        alert('宛先情報（郵便番号・住所・会社名・宛名・電話番号）は必須です。');
        return;
      }
      if (!arrivalDate || !arrivalTimeSlot) {
        alert('到着希望日と希望時間帯を選択してください。');
        return;
      }

      var people = parseInt(numPeople.value) || 0;
      var teams = parseInt(numTeams.value) || 0;
      if (people < 1 || teams < 1) {
        alert('研修人数とチーム数を入力し、数量を算出してください。');
        return;
      }

      // 品目収集
      var rows = itemTableBody.querySelectorAll('tr');
      var selectedItems = [];
      rows.forEach(function (row) {
        var cells = row.querySelectorAll('td');
        if (cells.length >= 7) {
          var name = cells[0].textContent;
          var qty = cells[6].textContent.trim();
          if (qty !== '-' && qty !== '0') {
            selectedItems.push(name + ' × ' + qty);
          }
        }
      });

      if (selectedItems.length === 0) {
        alert('発注する品目がありません。');
        return;
      }

      // 宛先文字列を組み立て
      var destStr = '〒' + destZip + ' ' + destAddress + '<br>' +
        destCompany + (destDept ? ' ' + destDept : '') + '<br>' +
        destName + '　TEL: ' + destPhone;

      // メンター情報を収集
      var mentors = selectedMentorIds.map(function (id) {
        var m = mentorDB.find(function (x) { return x.id === id; });
        return m ? m.name + '（' + m.email + '）' : '';
      }).filter(function (x) { return x; });

      modalMessage.innerHTML =
        '<strong>発注者:</strong> ' + ordererName + '（' + department + '）<br>' +
        '<strong>研修:</strong> ' + currentTraining.name + '<br><br>' +
        '<strong>宛先:</strong><br>' + destStr + '<br><br>' +
        '<strong>到着希望:</strong> ' + arrivalDate + '　' + arrivalTimeSlot + '<br>' +
        '<strong>人数:</strong> ' + people + '名 / <strong>チーム数:</strong> ' + teams + '<br><br>' +
        '<strong>発注品目:</strong><br>' +
        selectedItems.map(function (item) { return '・' + item; }).join('<br>') +
        '<br><br>' +
        (mentors.length > 0
          ? '<strong>チェック権限付与メンター:</strong><br>' + mentors.map(function (m) { return '・' + m; }).join('<br>') + '<br><br>'
          : '') +
        'この内容で閲覧用シート＆フォームを生成し、<br>Slackでアズロジ側へ共有します。よろしいですか？';

      confirmModal.classList.add('is-visible');
    });

    // モーダル：キャンセル
    btnModalCancel.addEventListener('click', function () {
      confirmModal.classList.remove('is-visible');
    });

    // モーダル：確定
    btnModalConfirm.addEventListener('click', function () {
      confirmModal.classList.remove('is-visible');
      successAlert.classList.add('is-visible');
      setTimeout(function () {
        successAlert.classList.remove('is-visible');
      }, 4000);
    });

    // モーダル外クリックで閉じる
    confirmModal.addEventListener('click', function (e) {
      if (e.target === confirmModal) {
        confirmModal.classList.remove('is-visible');
      }
    });

  })();
  </script>

</body>
</html>
